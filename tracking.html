<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“¦ ØªØªØ¨Ø¹ Ø´Ø­Ù†ØªÙƒ - Ù…ÙƒØªØ¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background: #fff7f0; padding: 20px; text-align: center; }
    h2 { color: #ff6600; }
    .order-box {
      background: #fff3e6; margin: 15px auto; padding: 15px; border-radius: 10px;
      border: 1px solid #ccc; width: 320px; box-shadow: 2px 2px 5px #ddd; text-align: right;
    }
    #logoutBtn {
      position: absolute; left: 20px; top: 20px; background: #d9534f; color: #fff;
      border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;
    }
    #logoutBtn:hover { background: #c9302c; }
    #invoiceContainer { display: none; margin-top: 20px; }
    #invoiceTotal { font-weight: bold; color: green; margin-top: 10px; }
    #userEmail { color: #333; margin-top: 10px; }
    .muted { color: #666; font-size: 14px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCgwSsXr3iuFofbbjojAVbz8wKfisntOlc",
      authDomain: "baynelsotoor.firebaseapp.com",
      projectId: "baynelsotoor",
      storageBucket: "baynelsotoor.appspot.com",
      messagingSenderId: "1039807635070",
      appId: "1:1039807635070:web:5b02088c19edb30a68822f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);
    const shipmentsRef = collection(db, "shipments");
    const paymentsRef  = collection(db, "payments"); // Ù…Ù† ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹

    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ø­Ù„ÙŠ)
    window.addEventListener("DOMContentLoaded", () => {
      const logoutBtn = document.getElementById("logoutBtn");
      logoutBtn.addEventListener("click", () => {
        localStorage.removeItem("loggedIn");
        localStorage.removeItem("userName");
        localStorage.removeItem("userEmail");
        alert("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.");
        window.location.href = "login.html";
      });
    });

    // Ø§Ù„Ø­Ù…Ø§ÙŠØ© + ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    window.addEventListener("DOMContentLoaded", async () => {
      const loggedIn = localStorage.getItem("loggedIn") === "true";
      const email = localStorage.getItem("userEmail");

      if (!loggedIn || !email) {
        // Ù„Ùˆ Ù…Ø´ Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„
        window.location.href = "login.html";
        return;
      }

      document.getElementById("userEmail").textContent = `ğŸ“§ Ø­Ø³Ø§Ø¨Ùƒ: ${email}`;

      // 1) Ø¬Ù„Ø¨ Ø§Ù„Ø´Ø­Ù†Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
      const sQuery = query(shipmentsRef, where("email", "==", email));
      const sSnap  = await getDocs(sQuery);
      const list   = document.getElementById("ordersList");
      list.innerHTML = "";

      if (sSnap.empty) {
        list.innerHTML = "<p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø­Ù†Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨Ùƒ.</p>";
        return; // Ù…Ø§ Ù†Ø¹Ø±Ø¶Ø´ ÙØ§ØªÙˆØ±Ø©
      }

      // Ø­Ø¶Ù‘Ø±ÙŠ Ø®Ø±ÙŠØ·Ø© Ø£Ø³Ø¹Ø§Ø± Ù…Ù† Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª: trackingNumber -> amount
      const pQuery = query(paymentsRef, where("email", "==", email));
      const pSnap  = await getDocs(pQuery);
      const priceMap = new Map();
      pSnap.forEach(doc => {
        const d = doc.data();
        const tn = d.trackingNumber || d.orderId; // Ù„Ùˆ Ø¨ØªØ³Ù…ÙŠÙ‡Ø§ orderId Ø¹Ø¯Ù‘Ù„ÙŠ Ù‡Ù†Ø§
        const amount = Number(d.amount) || 0;
        if (tn) priceMap.set(tn, (priceMap.get(tn) || 0) + amount);
      });

      let grandTotal = 0;

      sSnap.forEach(doc => {
        const d = doc.data();
        const tn = d.trackingNumber || d.orderId || doc.id;
        const status = d.status || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
        const last = d.lastUpdate?.toDate?.() ? d.lastUpdate.toDate() : null;

        // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ£Ø®ÙŠØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        let delayNotice = "";
        if (last) {
          const diffDays = Math.floor((Date.now() - last.getTime()) / (1000 * 60 * 60 * 24));
          if (status !== "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…" && diffDays >= 4) {
            delayNotice = `<p style="color:red;">âš ï¸ Ø§Ù„Ø´Ø­Ù†Ø© Ù…ØªØ£Ø®Ø±Ø© ${diffDays} ÙŠÙˆÙ…</p>`;
          }
        }

        const amount = Number(priceMap.get(tn) || 0);
        grandTotal += amount;

        const item = document.createElement("div");
        item.className = "order-box";
        item.innerHTML = `
          <p><strong>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</strong> ${tn}</p>
          <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${status}</p>
          ${delayNotice}
          <p class="muted"><strong>Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†Ø©:</strong> ${amount > 0 ? amount + " Ø¬.Ù…" : "â€”"}</p>
        `;
        list.appendChild(item);
      });

      // 3) Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø© ÙÙ‚Ø· Ù„Ùˆ ÙÙŠÙ‡ Ø´Ø­Ù†Ø§Øª (ÙˆÙ…Ù…ÙƒÙ† ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØµÙØ± Ù„Ùˆ Ù„Ø³Ù‡ Ù…Ø§ Ø§ØªØ¯ÙØ¹ØªØ´)
      const invoiceContainer = document.getElementById("invoiceContainer");
      const invoiceTotal     = document.getElementById("invoiceTotal");
      invoiceContainer.style.display = "block";
      invoiceTotal.textContent = `ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${grandTotal} Ø¬.Ù…`;
    });
  </script>
</head>
<body>
  <button id="logoutBtn">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  <h2>ğŸ“¦ ØªØªØ¨Ø¹ Ø´Ø­Ù†ØªÙƒ</h2>
  <p id="userEmail"></p>

  <div id="ordersList">
    <p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø´Ø­Ù†Ø§ØªÙƒ...</p>
  </div>

  <div id="invoiceContainer">
    <hr style="max-width:360px; margin:20px auto;">
    <div id="invoiceTotal"></div>
    <p class="muted">ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù†Ø§Øª ØªÙØ¬Ù„Ø¨ Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¯ÙØ¹ (payments).</p>
  </div>
</body>
</html>
