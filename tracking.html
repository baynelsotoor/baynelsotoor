<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“¦ ØªØªØ¨Ø¹ Ø´Ø­Ù†ØªÙƒ - Ù…ÙƒØªØ¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ±</title>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Cairo', sans-serif; background: #fff7f0; padding: 20px; text-align: center; }
    h2 { color: #ff6600; }
    .order-box {
      background: #fff3e6; margin: 15px auto; padding: 15px; border-radius: 10px;
      border: 1px solid #ccc; width: 320px; box-shadow: 2px 2px 5px #ddd; text-align: right;
    }
    #logoutBtn {
      position: absolute; left: 20px; top: 20px; background: #d9534f; color: #fff;
      border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer;
    }
    #logoutBtn:hover { background: #c9302c; }
    #invoiceContainer { display: none; margin-top: 20px; }
    #invoiceTotal { font-weight: bold; color: green; margin-top: 10px; }
    #userEmail { color: #333; margin-top: 10px; }
    .muted { color: #666; font-size: 14px; }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase (Ù…Ù† Ù…Ø´Ø±ÙˆØ¹Ùƒ)
    const firebaseConfig = {
      apiKey: "AIzaSyCgwSsXr3iuFofbbjojAVbz8wKfisntOlc",
      authDomain: "baynelsotoor.firebaseapp.com",
      projectId: "baynelsotoor",
      storageBucket: "baynelsotoor.appspot.com",
      messagingSenderId: "1039807635070",
      appId: "1:1039807635070:web:5b02088c19edb30a68822f"
    };

    const app = initializeApp(firebaseConfig);
    const db  = getFirestore(app);

    // Ù…Ø±Ø¬Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª
    const shipmentsRef = collection(db, "shipments");
    const paymentsRef  = collection(db, "payments");

    // Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
    window.addEventListener("DOMContentLoaded", () => {
      document.getElementById("logoutBtn").addEventListener("click", () => {
        localStorage.clear();
        alert("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.");
        window.location.href = "login.html";
      });
    });

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
    window.addEventListener("DOMContentLoaded", () => {
      const email = localStorage.getItem("userEmail");
      const loggedIn = localStorage.getItem("loggedIn") === "true";

      if (!loggedIn || !email) {
        window.location.href = "login.html";
        return;
      }

      document.getElementById("userEmail").textContent = `ğŸ“§ Ø­Ø³Ø§Ø¨Ùƒ: ${email}`;

      // Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù„Ù„Ø´Ø­Ù†Ø§Øª
      const sQuery = query(shipmentsRef, where("email", "==", email));
      onSnapshot(sQuery, (sSnap) => {
        const list = document.getElementById("ordersList");
        list.innerHTML = "";

        if (sSnap.empty) {
          list.innerHTML = "<p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø´Ø­Ù†Ø§Øª Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø­Ø³Ø§Ø¨Ùƒ.</p>";
          document.getElementById("invoiceContainer").style.display = "none";
          return;
        }

        let grandTotal = 0;

        sSnap.forEach(doc => {
          const d = doc.data();

          // Ù„Ùˆ Ù…ÙÙŠØ´ trackingNumberØŒ Ù†ÙˆÙ„Ø¯Ù‡ Ø£ÙˆØªÙˆÙ…Ø§ØªÙŠÙƒ
          const tn = d.trackingNumber || ("ORD-" + doc.id.slice(-6));
          const status = d.status || "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©";

          // Ø§Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø± (Ù†Ø¬Ù…Ø¹ Ù…Ù† payments)
          let amount = Number(d.amount) || 0;
          grandTotal += amount;

          const item = document.createElement("div");
          item.className = "order-box";
          item.innerHTML = `
            <p><strong>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</strong> ${tn}</p>
            <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${status}</p>
            <p class="muted"><strong>Ø³Ø¹Ø± Ø§Ù„Ø´Ø­Ù†Ø©:</strong> ${amount > 0 ? amount + " Ø¬.Ù…" : "â€”"}</p>
          `;
          list.appendChild(item);
        });

        // Ø¹Ø±Ø¶ Ø§Ù„ÙØ§ØªÙˆØ±Ø©
        const invoiceContainer = document.getElementById("invoiceContainer");
        const invoiceTotal     = document.getElementById("invoiceTotal");
        invoiceContainer.style.display = "block";
        invoiceTotal.textContent = `ğŸ’° Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${grandTotal} Ø¬.Ù…`;
      });
    });

    // ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø© ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© (30000 Ù…Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©)
    setInterval(() => {
      window.location.reload();
    }, 60000);
  </script>
</head>
<body>
  <button id="logoutBtn">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  <h2>ğŸ“¦ ØªØªØ¨Ø¹ Ø´Ø­Ù†ØªÙƒ</h2>
  <p id="userEmail"></p>

  <div id="ordersList">
    <p>â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø´Ø­Ù†Ø§ØªÙƒ...</p>
  </div>

  <div id="invoiceContainer">
    <hr style="max-width:360px; margin:20px auto;">
    <div id="invoiceTotal"></div>
    <p class="muted">ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©: Ø£Ø³Ø¹Ø§Ø± Ø§Ù„Ø´Ø­Ù†Ø§Øª ØªÙØ­Ø³Ø¨ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©.</p>
  </div>
</body>
</html>
