<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…ÙƒØªØ¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ±</title>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
    import {
      getFirestore, collection, addDoc, updateDoc, doc,
      getDocs, query, where, serverTimestamp, orderBy
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCgwSsXr3iuFofbbjojAVbz8wKfisntOlc",
      authDomain: "baynelsotoor.firebaseapp.com",
      projectId: "baynelsotoor",
      storageBucket: "baynelsotoor.appspot.com",
      messagingSenderId: "1039807635070",
      appId: "1:1039807635070:web:5b02088c19edb30a68822f"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const shipmentsRef = collection(db, "shipments");

    // Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ù„Ù‡ ÙƒØ£Ø¯Ù…Ù†
    const adminEmail = "ritajayman77@gmail.com";

    // Ù…Ø±Ø§Ø¬Ø¹ DOM
    const state = {
      allShipments: [] // Ù‡Ù†Ø®Ø²Ù† ÙÙŠÙ‡Ø§ ÙƒÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª Ù„Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    };

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù€ DOM: Ø£Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø³Ø±ÙŠØ¹Ø©
    document.addEventListener("DOMContentLoaded", () => {
      // ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
      document.getElementById("logoutBtn").addEventListener("click", async () => {
        await signOut(auth);
        alert("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.");
        window.location.href = "login.html";
      });

      // Ø­ÙØ¸/ØªØ­Ø¯ÙŠØ« Ø´Ø­Ù†Ø©
      document.getElementById("shipmentForm").addEventListener("submit", handleUpsert);

      // ÙÙ„ØªØ±Ø© ÙÙˆØ±ÙŠØ©
      document.getElementById("filterTracking").addEventListener("input", renderFiltered);
      document.getElementById("filterEmail").addEventListener("input", renderFiltered);

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³Ø­Ø§Ø¨Ø©
      document.getElementById("reloadBtn").addEventListener("click", loadShipments);
    });

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      if (user.email !== adminEmail) {
        alert("âŒ ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….");
        window.location.href = "index.html";
        return;
      }
      document.getElementById("userEmail").textContent = user.email;
      loadShipments();
    });

    // ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª Ù…Ù† Firestore
    async function loadShipments() {
      setLoading(true);
      try {
        // ØªØ±ØªÙŠØ¨ Ø¨Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
        const snap = await getDocs(shipmentsRef);
        const items = [];
        snap.forEach((docSnap) => {
          const data = docSnap.data();
          items.push({
            id: docSnap.id,
            trackingNumber: data.trackingNumber || "",
            email: data.email || "",
            status: data.status || "",
            location: data.location || "",
            lastUpdate: data.lastUpdate?.toDate?.() || null
          });
        });
        // Ø®Ø²Ù‘Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ù…Ù„Ø© Ù„Ù„ÙÙ„ØªØ±
        state.allShipments = items.sort((a, b) => (b.lastUpdate?.getTime?.() || 0) - (a.lastUpdate?.getTime?.() || 0));
        renderFiltered(); // Ø§Ø¹Ø±Ø¶ Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      } catch (e) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª.");
        console.error(e);
      } finally {
        setLoading(false);
      }
    }

    // Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ« Ø´Ø­Ù†Ø©
    async function handleUpsert(e) {
      e.preventDefault();
      const trackingNumber = document.getElementById("trackingNumber").value.trim();
      const email = document.getElementById("email").value.trim().toLowerCase();
      const status = document.getElementById("status").value.trim();
      const location = document.getElementById("location").value.trim();

      if (!trackingNumber || !email || !status) {
        alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø¦ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©.");
        return;
      }

      setSubmitting(true);
      try {
        // Ù‡Ù„ Ø§Ù„Ø´Ø­Ù†Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©ØŸ
        const qTrack = query(shipmentsRef, where("trackingNumber", "==", trackingNumber));
        const snap = await getDocs(qTrack);

        if (snap.empty) {
          // Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø©
          await addDoc(shipmentsRef, {
            trackingNumber,
            email,
            status,
            location,
            lastUpdate: serverTimestamp()
          });
          alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø´Ø­Ù†Ø© Ø¨Ù†Ø¬Ø§Ø­!");
        } else {
          // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ (Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ§Ø­Ø¯Ø© Ø¨Ù†ÙØ³ Ø§Ù„Ø±Ù‚Ù… â€“ Ù‡Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„ÙƒÙ„)
          const promises = [];
          snap.forEach((docSnap) => {
            promises.push(
              updateDoc(doc(db, "shipments", docSnap.id), {
                // Ù†Ø³Ù…Ø­ Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙƒÙ…Ø§Ù† Ù„Ùˆ Ø¹Ø§ÙŠØ²Ø© ØªÙ†Ù‚Ù„ÙŠÙ‡Ø§ Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ§Ù†ÙŠ
                email,
                status,
                location,
                lastUpdate: serverTimestamp()
              })
            );
          });
          await Promise.all(promises);
          alert("âœï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø´Ø­Ù†Ø©!");
        }

        // ØµÙÙ‘ÙŠ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙˆØ­Ù…Ù‘Ù„ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙŠØ¯
        document.getElementById("shipmentForm").reset();
        await loadShipments();
      } catch (e) {
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸/Ø§Ù„ØªØ­Ø¯ÙŠØ«.");
        console.error(e);
      } finally {
        setSubmitting(false);
      }
    }

    // Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø­Ø³Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ±
    function renderFiltered() {
      const tFilter = document.getElementById("filterTracking").value.trim().toLowerCase();
      const eFilter = document.getElementById("filterEmail").value.trim().toLowerCase();

      const list = document.getElementById("shipmentsList");
      list.innerHTML = "";

      const filtered = state.allShipments.filter((s) => {
        const byT = tFilter ? s.trackingNumber.toLowerCase().includes(tFilter) : true;
        const byE = eFilter ? s.email.toLowerCase().includes(eFilter) : true;
        return byT && byE;
      });

      if (!filtered.length) {
        list.innerHTML = `<p>ğŸ“­ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</p>`;
        return;
      }

      filtered.forEach((s) => {
        const div = document.createElement("div");
        div.className = "shipment";
        const dateTxt = s.lastUpdate
          ? s.lastUpdate.toLocaleString("ar-EG", { dateStyle: "medium", timeStyle: "short" })
          : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

        div.innerHTML = `
          <p><strong>ğŸ“¦ Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹:</strong> ${s.trackingNumber}</p>
          <p><strong>ğŸ‘¤ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„:</strong> ${s.email}</p>
          <p><strong>ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${s.status}</p>
          <p><strong>ğŸ—ºï¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> ${s.location || "â€”"}</p>
          <p><strong>â° Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:</strong> ${dateTxt}</p>
          <hr>
        `;
        list.appendChild(div);
      });
    }

    // Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„/Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    function setLoading(flag) {
      const el = document.getElementById("loadingHint");
      el.style.display = flag ? "block" : "none";
    }
    function setSubmitting(flag) {
      const btn = document.getElementById("saveBtn");
      btn.disabled = flag;
      btn.textContent = flag ? "Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸..." : "Ø­ÙØ¸";
    }
  </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      background-color: #fff7f0;
      padding: 20px;
    }
    h2 { color: #ff6600; text-align:center; margin-bottom: 10px; }
    #logoutBtn {
      background:#d9534f; color:#fff; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;
      position: absolute; left: 20px; top: 20px;
    }
    #logoutBtn:hover { background:#c9302c; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .bar {
      display:flex; gap:10px; align-items:center; justify-content:space-between; margin: 12px 0 18px;
      background:#fff3e6; padding:10px; border-radius:10px; box-shadow:2px 2px 6px #ccc;
      flex-wrap: wrap;
    }
    .bar .left, .bar .right { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .bar input {
      padding:8px 10px; border:1px solid #ccc; border-radius:6px; min-width: 220px;
    }
    .bar button {
      background:#17a2b8; color:#fff; border:none; padding:8px 14px; border-radius:6px; cursor:pointer;
    }
    .bar button:hover { background:#13899c; }
    .form-box {
      background:#fff3e6; padding:15px; border-radius:10px; margin:10px auto 20px; width:360px; max-width:100%;
      box-shadow:2px 2px 6px #ccc;
    }
    .form-box input, .form-box select {
      width:100%; padding:8px; margin:6px 0; border:1px solid #ccc; border-radius:6px;
    }
    .form-box button {
      background:#28a745; color:#fff; padding:10px; border:none; border-radius:6px; cursor:pointer;
      width:100%; margin-top:10px;
    }
    .form-box button[disabled] { opacity: .6; cursor: not-allowed; }
    .form-box button:hover:not([disabled]) { background:#218838; }
    .shipment {
      background:#fafafa; margin:10px 0; padding:10px; border:1px solid #ddd; border-radius:6px;
    }
    #shipmentsList { margin-top: 10px; }
    #loadingHint { display:none; margin: 10px 0; }
  </style>
</head>
<body>
  <button id="logoutBtn">ğŸ”“ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  <div class="wrap">
    <h2>âš™ï¸ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h2>
    <p>Ù…Ø±Ø­Ø¨Ø§Ù‹ <span id="userEmail"></span></p>

    <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª: ÙÙ„Ø§ØªØ± + Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ -->
    <div class="bar">
      <div class="left">
        <input type="text" id="filterTracking" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹">
        <input type="email" id="filterEmail" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„">
      </div>
      <div class="right">
        <button id="reloadBtn">â†» Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firestore</button>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ©/ØªØ­Ø¯ÙŠØ« -->
    <div class="form-box">
      <h3>â• Ø¥Ø¶Ø§ÙØ© / âœï¸ ØªØ­Ø¯ÙŠØ« Ø´Ø­Ù†Ø©</h3>
      <form id="shipmentForm">
        <input type="text" id="trackingNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹" required />
        <input type="email" id="email" placeholder="Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" required />
        <select id="status" required>
          <option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²">ğŸ“¦ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
          <option value="ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚">ğŸšš ÙÙŠ Ø§Ù„Ø·Ø±ÙŠÙ‚</option>
          <option value="ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…">âœ… ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
        </select>
        <input type="text" id="location" placeholder="Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
        <button id="saveBtn" type="submit">Ø­ÙØ¸</button>
      </form>
    </div>

    <div id="loadingHint">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª...</div>

    <h3>ğŸ“‹ ÙƒÙ„ Ø§Ù„Ø´Ø­Ù†Ø§Øª</h3>
    <div id="shipmentsList">
      <p>â€” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯ â€”</p>
    </div>
  </div>
</body>
  </html>
