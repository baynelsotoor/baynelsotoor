<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø­Ù† - Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ±</title>

  <!-- ğŸ” Ø­Ù…Ø§ÙŠØ© Ø¨ÙƒÙ„Ù…Ø© Ø³Ø± -->
  <script>
    const correctPassword = "retaj2025";
    const entered = sessionStorage.getItem("admin-auth");

    if (entered !== "yes") {
      const userPassword = prompt("ğŸ” Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ù„Ù„Ø¯Ø®ÙˆÙ„:");
      if (userPassword === correctPassword) {
        sessionStorage.setItem("admin-auth", "yes");
      } else {
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
        window.location.href = "index.html";
      }
    }
  </script>

  <!-- ğŸ”— Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCgwSsXr3iuFofbbjojAVbz8wKfisntOlc",
      authDomain: "baynelsotoor.firebaseapp.com",
      projectId: "baynelsotoor",
      storageBucket: "baynelsotoor.appspot.com",
      messagingSenderId: "1039807635070",
      appId: "1:1039807635070:web:5b02088c19edb30a68822f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const ordersRef = collection(db, "shipments");

    async function loadOrders() {
      const snapshot = await getDocs(ordersRef);
      const tbody = document.querySelector("#ordersBody");
      tbody.innerHTML = "";

      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const isLocked = ["Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†", "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"].includes(data.status);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.email}</td>
          <td>${data.trackingNumber}</td>
          <td>
            ${isLocked
              ? `<span>${data.status}</span>` 
              : `<select onchange="updateStatus('${docSnap.id}', this.value)">
                  ${["ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨", "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²", "Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†", "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„", "ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…"]
                    .map(s => `<option value="${s}" ${s === data.status ? "selected" : ""}>${s}</option>`).join("")}
                </select>`
            }
          </td>
          <td>
            ${isLocked 
              ? `<span style="color: #888;">ğŸ”’ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù</span>` 
              : `<button onclick="deleteOrder('${docSnap.id}')">ğŸ—‘ Ø­Ø°Ù</button>`
            }
          </td>
        `;
        tbody.appendChild(row);
      });
    }

    async function addOrder() {
      const email = document.getElementById("email").value.trim();
      const trackingNumber = document.getElementById("trackingNumber").value.trim();
      const status = document.getElementById("orderStatus").value;

      if (!email || !trackingNumber) {
        alert("âŒ Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ù…Ù„Ø£ ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„");
        return;
      }

      await addDoc(ordersRef, {
        email,
        trackingNumber,
        status,
        lastUpdate: serverTimestamp()
      });

      alert("âœ… ØªÙ… Ø§Ù„Ø¥Ø¶Ø§ÙØ©!");
      document.getElementById("email").value = "";
      document.getElementById("trackingNumber").value = "";
      loadOrders();
    }

    async function deleteOrder(id) {
      if (confirm("â— Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ")) {
        await deleteDoc(doc(db, "shipments", id));
        loadOrders();
      }
    }

    async function updateStatus(id, newStatus) {
      await updateDoc(doc(db, "shipments", id), {
        status: newStatus,
        lastUpdate: serverTimestamp()
      });
    }

    window.addOrder = addOrder;
    window.deleteOrder = deleteOrder;
    window.updateStatus = updateStatus;
    window.onload = loadOrders;
  </script>

  <style>
    body {
      font-family: 'Cairo', sans-serif;
      padding: 20px;
      background: #fff3e6;
      text-align: center;
    }

    input, select {
      padding: 10px;
      margin: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: 250px;
    }

    button {
      padding: 8px 12px;
      background: #ff8c42;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    button:hover {
      background-color: #e67300;
    }

    table {
      margin-top: 20px;
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }

    th {
      background: #f7d9c4;
    }

    .invoice {
      margin-top: 30px;
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>ğŸ“¦ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø´Ø­Ù† - Ø¨ÙŠÙ† Ø§Ù„Ø³Ø·ÙˆØ±</h2>

  <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø¹Ù…ÙŠÙ„" />
  <input type="text" id="trackingNumber" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹" />
  <select id="orderStatus">
    <option>ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨</option>
    <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù‡ÙŠØ²</option>
    <option>Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù†</option>
    <option>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙˆØµÙŠÙ„</option>
    <option>ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ…</option>
  </select>
  <br />
  <button onclick="addOrder()">â• Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ù„Ø¨</button>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</th>
        <th>Ø±Ù‚Ù… Ø§Ù„ØªØªØ¨Ø¹</th>
        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
        <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr>
    </thead>
    <tbody id="ordersBody"></tbody>
  </table>

  <div class="invoice">
    ğŸ’° <button onclick="showInvoice()">Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</button>
    <p id="invoiceOutput"></p>
  </div>

  <script>
    function showInvoice() {
      const tbody = document.querySelector("#ordersBody");
      const rows = tbody.querySelectorAll("tr");
      const total = rows.length * 50; // Ø§ÙØªØ±Ø¶ÙŠ Ø¥Ù† ÙƒÙ„ Ø´Ø­Ù†Ø© Ø¨Ù€ 50 Ø¬Ù†ÙŠÙ‡
      document.getElementById("invoiceOutput").textContent = `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ§ØªÙˆØ±Ø©: ${total} Ø¬Ù†ÙŠÙ‡ Ù…ØµØ±ÙŠ`;
    }
  </script>

</body>
</html>
